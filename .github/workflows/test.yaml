name: Helm CI Pipeline

on:
  workflow_dispatch:

jobs:
  lint:
    name: ğŸ§¹ Helm Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.14.0

      - name: Helm Lint
        run: helm lint ./myapp-chart

  template:
    name: ğŸ§ª Helm Template (Dry Run)
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - uses: azure/setup-helm@v3
        with:
          version: v3.14.0

      - name: Helm Template Render
        run: |
          helm template testrelease ./myapp-chart

  chart-test:
    name: âœ… Helm Chart Install Test (Kind)
    runs-on: ubuntu-latest
    needs: template
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Kind
        uses: helm/kind-action@v1.8.0

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.14.0

      - name: Lint with chart-testing
        uses: helm/chart-testing-action@v2.6.1
        with:
          command: lint
          charts: myapp-chart

      - name: Install Chart on Kind
        uses: helm/chart-testing-action@v2.6.1
        with:
          command: install
          charts: myapp-chart

  kubeval:
    name: ğŸ” Kubernetes Manifest Validation
    runs-on: ubuntu-latest
    needs: template
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v3

      - name: Render Templates
        run: |
          helm template testrelease ./myapp-chart > rendered.yaml

      - name: Install kube-score
        run: |
          curl -sSL https://github.com/zegl/kube-score/releases/latest/download/kube-score_ubuntu_linux_amd64 -o kube-score
          chmod +x kube-score
          sudo mv kube-score /usr/local/bin/kube-score

      - name: Run kube-score
        run: kube-score score rendered.yaml

  package:
    name: ğŸ“¦ Helm Package
    runs-on: ubuntu-latest
    needs: [lint, template]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v3

      - name: Package Helm Chart
        run: |
          helm package ./myapp-chart
          mkdir -p chart-packages
          mv myapp-chart-*.tgz chart-packages/

      - name: Upload Helm Chart Artifact
        uses: actions/upload-artifact@v4
        with:
          name: helm-chart
          path: chart-packages/

  secrets:
    name: ğŸ” Secret Scan (Optional)
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
